name: ci

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: ruff
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install ruff
      - run: ruff check skills/ scripts/
      - run: ruff format --check skills/ scripts/

  sast:
    name: bandit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install bandit[toml]
      - name: Run Bandit (HIGH severity = fail)
        # -lll = HIGH+ severity, -ii = MEDIUM+ confidence
        run: bandit -r skills/ scripts/ -lll -ii

  dependency-audit:
    name: pip-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install pip-audit
      - run: pip install -e .
      - name: Audit installed packages
        run: pip-audit --desc on

  validate-env:
    name: validate_env (layout + packages)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install -e .

      - name: Run pre-flight check (non-credential checks only)
        run: |
          python3 scripts/validate_env.py --ci --json > /tmp/preflight.json 2>/dev/null || true
          python3 - <<'PYEOF'
          import json, sys
          with open("/tmp/preflight.json") as f:
              data = json.load(f)
          cred_skip = {
              "SF_USERNAME", "SF_PASSWORD", "SF_SECURITY_TOKEN",
              "ANTHROPIC_API_KEY", ".env", "anthropic-key-format",
              "SF_DOMAIN", "SF_INSTANCE_URL",
          }
          failures = [
              r for r in data
              if r["status"] == "fail" and r["hard"] and r["name"] not in cred_skip
          ]
          if failures:
              print("FAIL:", [r["name"] + ": " + r["message"] for r in failures])
              sys.exit(1)
          print("OK — all non-credential pre-flight checks pass")
          PYEOF

  test:
    name: pytest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install -e ".[dev]" 2>/dev/null || pip install -e .
      - name: Run tests (if any exist)
        run: |
          if [ -d tests/ ]; then
            pytest tests/ -v
          else
            echo "No tests directory yet — skipping"
          fi
