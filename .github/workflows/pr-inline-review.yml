name: pr-inline-review

on:
  pull_request:
    paths:
      - "skills/**"
      - "scripts/**"
      - ".github/workflows/pr-inline-review.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  ruff-inline:
    name: Ruff (inline PR annotations)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install ruff

      - name: Ruff annotations on changed files
        run: ruff check skills/ scripts/ --output-format=github

  bandit-inline:
    name: Bandit SAST (inline PR annotations)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install bandit[toml]

      - name: Bandit annotations (HIGH+ = fail)
        run: bandit -r skills/ scripts/ -ll -ii -f json | python3 -c "
import json, sys
data = json.load(sys.stdin)
for r in data.get('results', []):
    sev = r['issue_severity']
    conf = r['issue_confidence']
    fname = r['filename']
    line = r['line_number']
    msg = r['issue_text']
    test = r['test_id']
    level = 'error' if sev == 'HIGH' else 'warning'
    print(f'::{level} file={fname},line={line}::{test}: [{sev}/{conf}] {msg}')
" || true
